<!DOCTYPE html>
<html lang="en" style="height: 100%">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>HEADER AND FOOTER</title>
    <style type="text/css">
      body {
        margin: auto;
      }
      .content {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .wrapper {
        flex-grow: 1;
      }
      .text-center {
        text-align: center;
      }
      .mb-2 {
        margin-bottom: 20px;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="content">
    <div id="header-1"></div>

    <div id="header-2"></div>

    <div id="header-3"></div>

    <div id="header-4"></div>

    <div id="header-5"></div>

    <div class="wrapper">
      <div class="text-center mb-2 hidden">
        <button type="button" onclick="setNewMessageIndicator('header-1-message-icon'); setNewMessageIndicator('header-3-message-icon'); setNewMessageIndicator('header-4-message-icon')">
          Показать индикатор новых сообщений в беседах
        </button>
        <button type="button" onclick="unsetNewMessageIndicator('header-1-message-icon'); unsetNewMessageIndicator('header-3-message-icon');unsetNewMessageIndicator('header-4-message-icon')">
          Убрать индикатор новых сообщений в беседах
        </button>
      </div>
    </div>

    <div id="footer"></div>

    <!-- Загрузка js/css из manifest.json -->
    <script>
      function fetchFile(file, callback) {
        var rawFile = new XMLHttpRequest();
        rawFile.overrideMimeType("application/json");
        rawFile.open("GET", file, true);
        rawFile.onreadystatechange = function () {
          if (rawFile.readyState === 4 && rawFile.status == "200") {
            callback(rawFile.responseText);
          }
        };
        rawFile.send(null);
      }

      function loadWidgetsSources(manifestText) {
        const manifestHost = getManifestHost();
        var data = JSON.parse(manifestText);
        loadScript(manifestHost + data["index.html"]["file"], createWidgets)
      }

      function getManifestHost() {
        const default_host = window.location.origin + "/";
        const params = getParams();
        if (params.manifest_host) { // для локального запуска: ?manifest_host=http://localhost:8080/
          return params.manifest_host;
        }
        
        return default_host;
      }

      function getParams() {
        return new Proxy(new URLSearchParams(window.location.search), {
          get: (searchParams, prop) => searchParams.get(prop),
        });
      }

      function loadScript(file, successCallback, moduleScript) {
        var script = document.createElement('script');
        script.src = file;
        if (moduleScript) {
          script.type = "module";
        }
        script.onload = successCallback;
        script.onerror = function() { logLoadError(file); }
        document.body.appendChild(script);
      }

      function logLoadError(file) {
        console.log("Failed to load resource " + file + "!");
      }

      function createWidgets() {
        messageButton = {
          type: "message",
          icon: "btn-message",
          url: "#",
          title: "Беседы"
        }
        homeButton = {
          type: "button",
          icon: "btn-home",
          url: "#",
          title: "Рабочее место исполнителя",
        }
        profileButton = {
          type: "profile",
          text: "Иванов И. И.",
          url: "#",
          title: "Профиль",
        }
        logoutButton = {
          type: "logout",
          icon: "btn-logout",
          url: "#",
          title: "Выход",
          method: "delete",
          text: "Выйти из системы",
        }

        // СЭД
        headerData1 = {
          fields: {
            logo: { url: "#", title: "Главная страница" },
            service_name: "Сервис электронного документооборота",
            right_part: [
              {
                type: "button",
                icon: "btn-folder",
                url: "#",
                title: "Архив долгосрочного хранения",
              },
              homeButton,
              Object.assign(messageButton, { message_new: true, messageIconId: 'header-1-message-icon' }),
              profileButton,
              logoutButton
            ]
          },
        }
        createHeader({ data: headerData1, element: "#header-1" })

        backArrow = {
          type: "button",
          icon: "btn-back-arrow",
          url: "http://localhost:8080",
          title: "Рабочее место делопроизводителя"
        }

        // WS
        headerData2 = {
          fields: {
            logo: { url: "#", title: "Главная страница" },
            service_name: "Сервис электронного документооборота",
            right_part: [
              {
                type: "button",
                icon: "btn-user",
                url: "http://localhost:8080",
                title: "График приёма"
              },
              {
                type: "button",
                icon: "btn-back-arrow",
                url: "http://localhost:8080",
                title: "Рабочее место делопроизводителя"
              },
              {
                type: "button",
                icon: "btn-home",
                url: "#",
                title: "Домой",
              },
              {
                type: "button",
                icon: "btn-stack",
                url: "#",
                title: "Зарегистрированные",
              },
              {
                type: "button",
                icon: "btn-star",
                url: "#",
                title: "Избранное"
              },
              {
                type: "button",
                icon: "btn-wrench",
                url: "#",
                title: "Обработанные"
              },
              {
                type: "button",
                icon: "btn-sort",
                url: "#",
                title: "Отправленные по маршруту"
              },
              {
                type: "button",
                icon: "btn-time",
                url: "#",
                title: "Активность профиля"
              },
              {
                type: "button",
                icon: "btn-calendar",
                url: "#",
                title: "Календарь событий"
              },
              profileButton,
              {
                type: "button",
                icon: "btn-cog",
                url: "#",
                title: "Настройки"
              },
              logoutButton
            ]
          },
        }
        createHeader({ data: headerData2, element: "#header-2" })

        // АДХ
        headerData3 = {
          fields: {
            logo: { url: "#", title: "Главная страница" },
            service_name: "Сервис электронного документооборота",
            right_part: [
              {
                type: "button",
                icon: "btn-back-arrow",
                url: "http://localhost:8080",
                title: "Рабочее место делопроизводителя"
              },
              homeButton,
              Object.assign(messageButton, { message_new: true, messageIconId: 'header-3-message-icon' }),
              profileButton,
              logoutButton
            ]
          },
        }
        createHeader({ data: headerData3, element: "#header-3" })

        // Журналирование
        headerData1['fields']['service_name'] = "Сервис журналирования"
        messageButton = Object.assign(messageButton, { message_new: true, messageIconId: 'header-4-message-icon' }),
        createHeader({ data: headerData1, element: "#header-4" })

        // Шапка без кнопок
        headerData5 = {
          fields: {
            logo: { url: "#", title: "Главная страница" },
            service_name: "Сервис электронного документооборота"
          },
        }
        createHeader({ data: headerData5, element: "#header-5" })
        
        createFooter({ element: "#footer" })

        hiddenElements = document.getElementsByClassName("hidden")
        while (hiddenElements.length) {
          hiddenElements[0].classList.remove("hidden");
        }
      }

      if (getParams().no_manifest) {
        loadScript("src/main.js", createWidgets, true)
      } else {
        fetchFile("/manifest.json", loadWidgetsSources);
      }
    </script>
  </body>
</html>
